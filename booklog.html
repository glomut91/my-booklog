<!DOCTYPE html>
<html lang="ko">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f4f7ff">
  <meta charset="UTF-8" />
  <title>ë…ì„œ ê¸°ë¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #4f8df5;
      --primary-soft: #e9f1ff;
      --primary-strong: #2b63d6;
      --border: #d6e1f7;
      --bg: #f4f7ff;
      --text-main: #111111;
      --text-muted: #667085;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 20px auto;
      padding: 0 12px 40px;
      background: var(--bg);
      color: var(--text-main);
    }
    body.modal-open {
      overflow: hidden;
      touch-action: none;
    }

    h1 {
      text-align: center;
      font-size: 1.7rem;
      margin-bottom: 8px;
      color: var(--primary-strong);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0 18px;
    }
    .tab-btn {
      flex: 1;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #ffffff;
      cursor: pointer;
      font-size: 0.95rem;
      color: var(--text-main);
    }
    .tab-btn.active {
      font-weight: 600;
      border-color: var(--primary);
      background: var(--primary-soft);
      color: var(--primary-strong);
      box-shadow: 0 2px 6px rgba(79,141,245,0.15);
    }

    .section { display: none; }
    .section.active { display: block; }

    /* í¼ */
    form {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 16px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(15,23,42,0.03);
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }
    .form-group {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      font-size: 0.85rem;
    }
    label {
      margin-bottom: 4px;
      color: var(--text-muted);
    }
    input[type="text"],
    input[type="date"],
    select,
    textarea {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      font-family: inherit;
      background: #ffffff;
    }
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(79,141,245,0.15);
    }
    textarea { resize: vertical; }

    .btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 6px;
      align-items: center;
    }
    button { cursor: pointer; }
    .primary {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      background: var(--primary);
      color: #ffffff;
    }
    .primary:active { transform: scale(0.98); }
    .secondary {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--primary-strong);
    }
    .secondary:active { transform: scale(0.98); }
    .danger {
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      border: 1px solid #fca5a5;
      background: #fee2e2;
      color: #b91c1c;
    }
    .danger:active { transform: scale(0.98); }

    /* í•„í„° */
    .filters {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 12px;
      font-size: 0.85rem;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(15,23,42,0.03);
    }
    .filters-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--primary-strong);
    }
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 6px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
      min-width: 120px;
      flex: 1;
    }
    .filter-group label {
      margin-bottom: 2px;
      font-size: 0.78rem;
      color: var(--text-muted);
    }
    .filters-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 4px;
    }

    /* í…Œì´ë¸” */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(15,23,42,0.03);
    }
    th, td {
      border-bottom: 1px solid #eef1f8;
      padding: 6px 6px;
      text-align: left;
      vertical-align: top;
    }
    th {
      background: var(--primary-soft);
      font-weight: 600;
      color: var(--primary-strong);
    }
    tr:nth-child(even) td { background: #fafbff; }

    .center { text-align: center; }
    .small  { font-size: 0.8rem; color: var(--text-muted); }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #e0e6f5;
      font-size: 0.78rem;
      display: inline-block;
      margin-right: 4px;
      background: #f5f7ff;
      color: #4b5563;
    }

    #empty-list {
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-top: 12px;
    }

    /* ì—´ ë„ˆë¹„ */
    th:nth-child(1), td:nth-child(1) { width: 58%; }
    th:nth-child(2), td:nth-child(2) { width: 22%; }
    th:nth-child(3), td:nth-child(3) { width: 10%; }
    th:nth-child(4), td:nth-child(4) { width: 10%; }

    td.format-cell { white-space: nowrap; }
    .nowrap { white-space: nowrap; }

    /* ë©”ëª¨ ë²„íŠ¼ */
    .memo-btn {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid var(--border);
      background: #ffffff;
      font-size: 0.9rem;
    }
    .memo-btn.has-memo {
      border-color: var(--primary);
      background: var(--primary-soft);
    }
    .memo-btn.no-memo {
      opacity: 0.45;
    }

    /* í†µê³„ */
    .stats-block {
      margin-bottom: 20px;
      background: #ffffff;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px 10px 4px;
      box-shadow: 0 2px 6px rgba(15,23,42,0.03);
    }
    .stats-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--primary-strong);
    }

    /* ===== ë©”ëª¨ ì „ì²´ í™”ë©´ (ë¦¬ìŠ¤íŠ¸ / í¸ì§‘) ===== */
    .memo-screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      display: none;
      flex-direction: column;
      z-index: 1200;
    }
    .memo-screen.active { display: flex; }

    .memo-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      background: var(--primary-soft);
      box-shadow: 0 1px 3px rgba(15,23,42,0.06);
    }
    .memo-header-title {
      font-weight: 600;
      font-size: 1rem;
      color: var(--primary-strong);
    }
    .memo-header-btn {
      border: none;
      background: transparent;
      font-size: 1.1rem;
      padding: 4px 6px;
      color: var(--text-muted);
    }
    .memo-header-btn.primary-text {
      color: var(--primary-strong);
      font-weight: 600;
      font-size: 1.05rem;
    }
    .memo-header-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .memo-book-info {
      padding: 6px 14px 4px;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
      background: #ffffff;
    }

    .memo-body {
      flex: 1;
      overflow-y: auto;
      padding: 10px 8px 16px;
    }
    .memo-footer {
      padding: 8px 12px 12px;
      border-top: 1px solid var(--border);
      background: #f0f4ff;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* ë©”ëª¨ ì¹´ë“œ - ë©”ëª¨ì§€ ëŠë‚Œ + ì—¬ë°± */
    .memo-card-full {
      position: relative;
      padding: 14px 12px 12px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #d3defa;
      margin: 10px 12px 22px;
      box-shadow: 0 2px 4px rgba(79,141,245,0.06);
      cursor: pointer;
    }
    .memo-card-full::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 6px;
      border-radius: 12px 12px 0 0;
      background: linear-gradient(to right, #9bb7ff, #4f8df5);
      opacity: 0.85;
    }
    .memo-card-full p {
      margin: 4px 0 0;
      white-space: pre-line;
      max-height: 9.6em;
      overflow: hidden;
      color: #111827;
      font-size: 0.96rem;
      line-height: 1.7;
    }
    .memo-card-full:hover {
      background: #f7f9ff;
    }
    .memo-card-full.drag-source {
      box-shadow: 0 0 0 2px rgba(79,141,245,0.35);
      border-color: #4f8df5;
    }

    .memo-empty {
      font-size: 0.85rem;
      color: var(--text-muted);
      text-align: center;
      margin-top: 12px;
    }

    /* ë©”ëª¨ í¸ì§‘ í…ìŠ¤íŠ¸ (ì „ì²´ í™”ë©´ ëŠë‚Œ) */
    .memo-body-edit {
      padding: 10px 0 16px;
    }
    #memo-edit-text {
      width: 100%;
      border: none;
      border-radius: 0;
      padding: 12px 16px;
      font-size: 0.98rem;
      line-height: 1.7;
      min-height: calc(100vh - 120px);
      resize: none;
      background: #fdfdff;
      box-sizing: border-box;
    }
    #memo-edit-text:focus {
      outline: none;
      border: none;
      box-shadow: none;
      background: #ffffff;
    }

    /* toast */
    #toast {
      position: fixed;
      left: 50%;
      bottom: 56px;
      transform: translateX(-50%) translateY(8px);
      background: rgba(26, 86, 219, 0.96);
      color: #ffffff;
      padding: 8px 16px;
      border-radius: 999px;
      font-size: 0.85rem;
      box-shadow: 0 10px 25px rgba(15,23,42,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 10000;
      max-width: 90%;
      text-align: center;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
    #toast.toast-show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    @media (max-width: 640px) {
      table,
      thead,
      tbody,
      th,
      td,
      tr {
        font-size: 0.8rem;
      }
      h1 { font-size: 1.4rem; }
      #toast { bottom: 40px; }
    }
  </style>
</head>
<body>
  <h1>ë…ì„œ ê¸°ë¡</h1>

  <div class="tabs">
    <button class="tab-btn active" data-tab="input-section">ì…ë ¥</button>
    <button class="tab-btn" data-tab="list-section">ê¸°ë¡</button>
    <button class="tab-btn" data-tab="stats-section">í†µê³„</button>
  </div>

  <!-- ===== ì…ë ¥ íƒ­ ===== -->
  <div id="input-section" class="section active">
    <form id="book-form">
      <div class="form-row">
        <div class="form-group">
          <label for="title">ì œëª©</label>
          <input type="text" id="title" required />
        </div>
        <div class="form-group">
          <label for="author">ì‘ê°€</label>
          <input type="text" id="author" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="genre">ë¶„ì•¼</label>
          <input type="text" id="genre" />
        </div>
        <div class="form-group">
          <label for="format">í˜•íƒœ</label>
          <select id="format">
            <option value=""></option>
            <option value="ebook">eë¶</option>
            <option value="paper">ì¢…ì´ì±…</option>
            <option value="audio">ì˜¤ë””ì˜¤ë¶</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="start-date">ì½ê¸° ì‹œì‘í•œ ë‚ ì§œ</label>
          <input type="date" id="start-date" />
        </div>
        <div class="form-group">
          <label for="finish-date">ì™„ë…í•œ ë‚ ì§œ</label>
          <input type="date" id="finish-date" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group" style="flex:1 1 100%">
          <label for="memo">ë©”ëª¨</label>
          <textarea id="memo" rows="4"></textarea>
        </div>
      </div>

      <div class="btn-row">
        <button type="button" class="danger" id="delete-btn" style="display:none; margin-right:auto;">ì‚­ì œ</button>
        <button type="button" class="secondary" id="reset-btn" style="display:none;">ì…ë ¥ ì·¨ì†Œ</button>
        <button type="submit" class="primary" id="submit-btn">ì¶”ê°€</button>
      </div>
      <input type="hidden" id="edit-index" value="" />
    </form>
  </div>

  <!-- ===== ê¸°ë¡ íƒ­ ===== -->
  <div id="list-section" class="section">
    <div class="filters">
      <div class="filters-title">í•„í„°</div>

      <!-- 1í–‰: ì œëª© / ì‘ê°€ -->
      <div class="filters-row">
        <div class="filter-group">
          <label for="filter-title">ì œëª©</label>
          <input type="text" id="filter-title" placeholder="ì œëª© ê²€ìƒ‰" />
        </div>
        <div class="filter-group">
          <label for="filter-author">ì‘ê°€</label>
          <input type="text" id="filter-author" placeholder="ì‘ê°€ ê²€ìƒ‰" />
        </div>
      </div>

      <!-- 2í–‰: ì—°ë„ / ë¶„ì•¼ -->
      <div class="filters-row">
        <div class="filter-group">
          <label for="filter-year">ì—°ë„</label>
          <select id="filter-year">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-genre">ë¶„ì•¼</label>
          <select id="filter-genre">
            <option value="">ì „ì²´</option>
          </select>
        </div>
      </div>

      <!-- 3í–‰: í˜•íƒœ / ë©”ëª¨ -->
      <div class="filters-row">
        <div class="filter-group">
          <label for="filter-format">í˜•íƒœ</label>
          <select id="filter-format">
            <option value="">ì „ì²´</option>
            <option value="ebook">eë¶</option>
            <option value="paper">ì¢…ì´ì±…</option>
            <option value="audio">ì˜¤ë””ì˜¤ë¶</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="filter-memo">ë©”ëª¨</label>
          <select id="filter-memo">
            <option value="">ì „ì²´</option>
            <option value="with">ë©”ëª¨ ìˆìŒ</option>
            <option value="without">ë©”ëª¨ ì—†ìŒ</option>
          </select>
        </div>
      </div>

      <div class="filters-actions">
        <button type="button" class="secondary" id="filter-reset-btn">í•„í„° ì´ˆê¸°í™”</button>
      </div>
    </div>

    <div id="empty-list">ì•„ì§ ë“±ë¡ëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
    <table id="book-table" style="display:none;">
      <thead>
        <tr>
          <th>ë„ì„œ</th>
          <th>ì½ì€ ë‚ ì§œ</th>
          <th class="center">í˜•íƒœ</th>
          <th class="center">ë©”ëª¨</th>
        </tr>
      </thead>
      <tbody id="book-tbody"></tbody>
    </table>
    <div class="small" id="list-summary"></div>
  </div>

  <!-- ===== í†µê³„ íƒ­ ===== -->
  <div id="stats-section" class="section">
    <div class="small" style="margin-bottom:8px;">
      â€» í†µê³„ëŠ” <strong>ì™„ë… ë‚ ì§œ</strong> ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤. (ì™„ë… ë‚ ì§œê°€ ì—†ëŠ” ì±…ì€ í†µê³„ì—ì„œ ì œì™¸)
    </div>

    <div class="stats-block">
      <div class="stats-title">ì „ì²´ ìš”ì•½</div>
      <div id="overall-stats" class="small">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <div class="stats-block">
      <div class="stats-title">ì—°ë„ë³„ í†µê³„</div>
      <table id="year-table" style="display:none;">
        <thead>
          <tr>
            <th>ì—°ë„</th>
            <th class="center">ì½ì€ ì±…</th>
          </tr>
        </thead>
        <tbody id="year-tbody"></tbody>
      </table>
      <div id="year-empty" class="small">ì—°ë„ë³„ í†µê³„ë¥¼ ê³„ì‚°í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <div class="stats-block">
      <div class="stats-title">ì›”ë³„ í†µê³„ (ì—°-ì›” ê¸°ì¤€)</div>
      <table id="month-table" style="display:none;">
        <thead>
          <tr>
            <th>ì—°-ì›”</th>
            <th class="center">ì½ì€ ì±…</th>
          </tr>
        </thead>
        <tbody id="month-tbody"></tbody>
      </table>
      <div id="month-empty" class="small">ì›”ë³„ í†µê³„ë¥¼ ê³„ì‚°í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- ===== ë©”ëª¨ ë¦¬ìŠ¤íŠ¸ ì „ì²´ í™”ë©´ ===== -->
  <div id="memo-screen" class="memo-screen">
    <div class="memo-header">
      <button type="button" class="memo-header-btn" id="memo-close-btn">âœ•</button>
      <div class="memo-header-title">ë©”ëª¨</div>
      <div style="width:40px;"></div>
    </div>
    <div class="memo-book-info" id="memo-book-info"></div>
    <div class="memo-body" id="memo-list-body">
      <div class="memo-empty" id="memo-empty-text">ì•„ì§ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ì•„ë˜ ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ë©”ëª¨ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”.</div>
      <div id="memo-list-container"></div>
    </div>
    <div class="memo-footer">
      <button type="button" class="primary" id="memo-new-btn">ìƒˆ ë©”ëª¨</button>
    </div>
  </div>

  <!-- ===== ë©”ëª¨ í¸ì§‘ ì „ì²´ í™”ë©´ ===== -->
  <div id="memo-edit-screen" class="memo-screen">
    <div class="memo-header">
      <button type="button" class="memo-header-btn" id="memo-edit-back-btn">â†</button>
      <div class="memo-header-title">ë©”ëª¨ í¸ì§‘</div>
      <div class="memo-header-actions">
        <button type="button" class="memo-header-btn" id="memo-edit-delete-btn">ğŸ—‘ï¸</button>
        <button type="button" class="memo-header-btn primary-text" id="memo-edit-save-btn">âœ”ï¸</button>
      </div>
    </div>
    <div class="memo-book-info" id="memo-edit-book-info"></div>
    <div class="memo-body memo-body-edit">
      <textarea id="memo-edit-text" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”."></textarea>
    </div>
  </div>

  <!-- toast -->
  <div id="toast"></div>

  <script>
    const STORAGE_KEY = "reading_log_v1";

    const form = document.getElementById("book-form");
    const titleInput = document.getElementById("title");
    const authorInput = document.getElementById("author");
    const genreInput = document.getElementById("genre");
    const startInput = document.getElementById("start-date");
    const finishInput = document.getElementById("finish-date");
    const formatSelect = document.getElementById("format");
    const memoInput = document.getElementById("memo");
    const editIndexInput = document.getElementById("edit-index");
    const submitBtn = document.getElementById("submit-btn");
    const resetBtn = document.getElementById("reset-btn");
    const deleteBtn = document.getElementById("delete-btn");

    const bookTable = document.getElementById("book-table");
    const bookTbody = document.getElementById("book-tbody");
    const emptyList = document.getElementById("empty-list");
    const listSummary = document.getElementById("list-summary");

    const overallStatsDiv = document.getElementById("overall-stats");
    const yearTable = document.getElementById("year-table");
    const yearTbody = document.getElementById("year-tbody");
    const yearEmpty = document.getElementById("year-empty");
    const monthTable = document.getElementById("month-table");
    const monthTbody = document.getElementById("month-tbody");
    const monthEmpty = document.getElementById("month-empty");

    const filterYear   = document.getElementById("filter-year");
    const filterTitle  = document.getElementById("filter-title");
    const filterAuthor = document.getElementById("filter-author");
    const filterGenre  = document.getElementById("filter-genre");
    const filterFormat = document.getElementById("filter-format");
    const filterMemo   = document.getElementById("filter-memo");
    const filterResetBtn = document.getElementById("filter-reset-btn");

    const memoScreen = document.getElementById("memo-screen");
    const memoBookInfo = document.getElementById("memo-book-info");
    const memoCloseBtn = document.getElementById("memo-close-btn");
    const memoNewBtn = document.getElementById("memo-new-btn");
    const memoListContainer = document.getElementById("memo-list-container");
    const memoEmptyText = document.getElementById("memo-empty-text");

    const memoEditScreen = document.getElementById("memo-edit-screen");
    const memoEditBackBtn = document.getElementById("memo-edit-back-btn");
    const memoEditSaveBtn = document.getElementById("memo-edit-save-btn");
    const memoEditDeleteBtn = document.getElementById("memo-edit-delete-btn");
    const memoEditText = document.getElementById("memo-edit-text");
    const memoEditBookInfo = document.getElementById("memo-edit-book-info");

    let memoBookIndex = null;
    let memoCardIndex = null;

    // ë“œë˜ê·¸ìš© ìƒíƒœ
    let memoDragSourceIndex = null;
    let memoDragJustHappened = false;

    let toastTimeout;
    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg;
      toast.classList.add("toast-show");
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toast.classList.remove("toast-show");
      }, 2300);
    }

    /* íƒ­ ì „í™˜ */
    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
        btn.classList.add("active");
        document.getElementById(btn.dataset.tab).classList.add("active");
        if (btn.dataset.tab === "stats-section") {
          renderStats();
        } else if (btn.dataset.tab === "list-section") {
          renderList();
        }
      });
    });

    /* ë¡œì»¬ìŠ¤í† ë¦¬ì§€ */
    function loadBooks() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch {
        return [];
      }
    }

    function saveBooks(books) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(books));
    }

    function clearForm() {
      form.reset();
      editIndexInput.value = "";
      submitBtn.textContent = "ì¶”ê°€";
      resetBtn.style.display = "none";
      deleteBtn.style.display = "none";
      formatSelect.value = "";
    }

    resetBtn.addEventListener("click", clearForm);

    deleteBtn.addEventListener("click", () => {
      const idxStr = editIndexInput.value;
      if (idxStr === "") return;
      const idx = Number(idxStr);
      if (!Number.isInteger(idx)) return;
      if (!confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?")) return;
      deleteBook(idx);
    });

    /* ì…ë ¥/ìˆ˜ì • ì €ì¥ */
    form.addEventListener("submit", (e) => {
      e.preventDefault();
      const title = titleInput.value.trim();
      if (!title) {
        showToast("ì œëª©ì€ í•„ìˆ˜ í•­ëª©ì…ë‹ˆë‹¤.");
        return;
      }

      const author = authorInput.value.trim();
      const genre = genreInput.value.trim();
      const startDate = startInput.value || "";
      const finishDate = finishInput.value || "";
      const format = formatSelect.value || "";
      const memo = memoInput.value || "";

      const book = { title, author, genre, startDate, finishDate, format, memo };

      const books = loadBooks();
      const editIndex = editIndexInput.value;
      let message = "";

      if (editIndex !== "") {
        const old = books[Number(editIndex)];
        if (old && Array.isArray(old.memos)) {
          book.memos = old.memos;
          book.memo = old.memos.join("\n\n");
        }
        books[Number(editIndex)] = book;
        message = "ë…ì„œ ê¸°ë¡ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
      } else {
        if (memo.trim()) {
          book.memos = [memo.trim()];
        }
        books.push(book);
        message = "ìƒˆ ë…ì„œ ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.";
      }
      saveBooks(books);
      clearForm();
      renderList();
      showToast(message);
    });

    function isFinished(book) {
      return !!book.finishDate;
    }

    function calcReadingDays(startDate, finishDate) {
      if (!startDate || !finishDate) return null;
      const s = new Date(startDate);
      const f = new Date(finishDate);
      if (isNaN(s.getTime()) || isNaN(f.getTime())) return null;
      const diffMs = f.getTime() - s.getTime();
      const diffDays = Math.round(diffMs / 86400000) + 1;
      return diffDays < 1 ? null : diffDays;
    }

    function ensureBookMemos(book) {
      if (!book.memos) book.memos = [];
      if (!Array.isArray(book.memos)) book.memos = [];
      if (book.memos.length === 0 && book.memo && book.memo.trim()) {
        book.memos.push(book.memo.trim());
      }
      return book.memos;
    }

    /* í•„í„° ì˜µì…˜ ì±„ìš°ê¸° */
    function updateFilterOptions(books) {
      const years = new Set();
      const genres = new Set();

      books.forEach(b => {
        if (b.finishDate && /^\d{4}/.test(b.finishDate)) {
          years.add(b.finishDate.slice(0,4));
        }
        if (b.genre) genres.add(b.genre);
      });

      const currentYear   = filterYear.value;
      const currentGenre  = filterGenre.value;
      const currentFormat = filterFormat.value;
      const currentMemo   = filterMemo.value;

      filterYear.innerHTML = '<option value="">ì „ì²´</option>';
      Array.from(years).sort((a,b)=>b.localeCompare(a)).forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y + "ë…„";
        filterYear.appendChild(opt);
      });
      if (currentYear && years.has(currentYear)) filterYear.value = currentYear;

      filterGenre.innerHTML = '<option value="">ì „ì²´</option>';
      Array.from(genres).sort((a,b)=>a.localeCompare(b)).forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        filterGenre.appendChild(opt);
      });
      if (currentGenre && genres.has(currentGenre)) filterGenre.value = currentGenre;

      filterFormat.value = currentFormat || "";
      filterMemo.value   = currentMemo || "";
    }

    function applyFilters(booksWithIndex) {
      const yearF   = filterYear.value;
      const titleF  = filterTitle.value.trim().toLocaleLowerCase();
      const authorF = filterAuthor.value.trim().toLocaleLowerCase();
      const genreF  = filterGenre.value;
      const formatF = filterFormat.value;
      const memoF   = filterMemo.value;

      return booksWithIndex.filter(b => {
        if (yearF) {
          if (!b.finishDate || b.finishDate.slice(0,4) !== yearF) return false;
        }
        if (titleF) {
          const t = (b.title || "").toLocaleLowerCase();
          if (!t.includes(titleF)) return false;
        }
        if (authorF) {
          const a = (b.author || "").toLocaleLowerCase();
          if (!a.includes(authorF)) return false;
        }
        if (genreF && (b.genre || "") !== genreF) return false;
        if (formatF && (b.format || "") !== formatF) return false;

        const memos = Array.isArray(b.memos) ? b.memos : [];
        const hasMemoArray = memos.some(m => m && m.trim());
        const hasLegacy = b.memo && b.memo.trim();
        const hasMemo = hasMemoArray || hasLegacy;

        if (memoF === "with" && !hasMemo) return false;
        if (memoF === "without" && hasMemo) return false;

        return true;
      });
    }

    filterYear.addEventListener("change", renderList);
    filterGenre.addEventListener("change", renderList);
    filterFormat.addEventListener("change", renderList);
    filterMemo.addEventListener("change", renderList);
    filterTitle.addEventListener("input", renderList);
    filterAuthor.addEventListener("input", renderList);

    filterResetBtn.addEventListener("click", () => {
      filterYear.value = "";
      filterTitle.value = "";
      filterAuthor.value = "";
      filterGenre.value = "";
      filterFormat.value = "";
      filterMemo.value = "";
      renderList();
    });

    /* ëª©ë¡ ë Œë”ë§ */
    function renderList() {
      const books = loadBooks();
      updateFilterOptions(books);

      if (books.length === 0) {
        bookTable.style.display = "none";
        emptyList.style.display = "block";
        emptyList.textContent = "ì•„ì§ ë“±ë¡ëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.";
        listSummary.textContent = "";
        return;
      }

      const booksWithIndex = books.map((b, idx) => ({ ...b, _index: idx }));
      const filtered = applyFilters(booksWithIndex);

      if (filtered.length === 0) {
        bookTable.style.display = "none";
        emptyList.style.display = "block";
        emptyList.textContent = "í•„í„° ì¡°ê±´ì— ë§ëŠ” ì±…ì´ ì—†ìŠµë‹ˆë‹¤.";
        listSummary.textContent = `ì´ ${books.length}ê¶Œ ê¸°ë¡ë¨ (í•„í„° ê²°ê³¼ 0ê¶Œ)`;
        return;
      } else {
        emptyList.style.display = "none";
      }

      const sorted = filtered.sort((a, b) => {
        const aFinished = isFinished(a);
        const bFinished = isFinished(b);
        if (aFinished !== bFinished) return aFinished ? 1 : -1;

        const aDate = a.finishDate || a.startDate || "";
        const bDate = b.finishDate || b.startDate || "";
        if (!aDate && !bDate) return 0;
        if (!aDate) return 1;
        if (!bDate) return -1;
        return bDate.localeCompare(aDate);
      });

      bookTable.style.display = "table";
      bookTbody.innerHTML = "";

      sorted.forEach(item => {
        const tr = document.createElement("tr");
        const finished = isFinished(item);

        const tdTitle = document.createElement("td");
        tdTitle.style.cursor = "pointer";
        tdTitle.title = "ëˆ„ë¥´ë©´ ìˆ˜ì •";
        let html = `<div>${escapeHtml(item.title)}</div>`;
        if (item.author) html += `<div class="small">${escapeHtml(item.author)}</div>`;
        if (item.genre) html += `<div class="small"><span class="tag">${escapeHtml(item.genre)}</span></div>`;
        tdTitle.innerHTML = html;
        tdTitle.addEventListener("click", () => {
          if (confirm("ì´ ì±… ì •ë³´ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) startEdit(item._index);
        });
        tr.appendChild(tdTitle);

        const tdDates = document.createElement("td");
        let period = "";
        if (item.startDate && item.finishDate) {
          const days = calcReadingDays(item.startDate, item.finishDate);
          if (days) period = `<span class="nowrap">${item.finishDate}(${days}ì¼)</span>`;
          else period = `<span class="nowrap">${item.finishDate}</span>`;
        } else if (item.finishDate || item.startDate) {
          const d = item.finishDate || item.startDate;
          period = `<span class="nowrap">${d}</span>`;
        } else {
          period = "<span class='small'>ë‚ ì§œ ì—†ìŒ</span>";
        }
        const statusText = finished ? "" : "ì½ëŠ” ì¤‘";
        tdDates.innerHTML = period + (statusText ? `<div class="small">${statusText}</div>` : "");
        tr.appendChild(tdDates);

        const tdFormat = document.createElement("td");
        tdFormat.className = "center small format-cell";
        tdFormat.textContent = formatToText(item.format);
        tr.appendChild(tdFormat);

        const tdMemo = document.createElement("td");
        tdMemo.className = "center";
        const memoBtn = document.createElement("button");

        const memos = Array.isArray(item.memos) ? item.memos : [];
        const hasMemoArray = memos.some(m => m && m.trim());
        const hasLegacy = item.memo && item.memo.trim();
        const hasMemo = hasMemoArray || hasLegacy;

        memoBtn.className = "memo-btn " + (hasMemo ? "has-memo" : "no-memo");
        memoBtn.textContent = "ğŸ“";
        memoBtn.title = hasMemo ? "ë©”ëª¨ ìˆìŒ" : "ë©”ëª¨ ì—†ìŒ";
        memoBtn.addEventListener("click", () => openMemoListScreen(item._index));
        tdMemo.appendChild(memoBtn);
        tr.appendChild(tdMemo);

        bookTbody.appendChild(tr);
      });

      const finishedCount = books.filter(b => b.finishDate).length;
      listSummary.textContent =
        `ì´ ${books.length}ê¶Œ ê¸°ë¡ë¨ (ì´ ì¤‘ ì™„ë… ${finishedCount}ê¶Œ, í•„í„° ê²°ê³¼ ${filtered.length}ê¶Œ)`;
    }

    /* ===== ë©”ëª¨ ë¦¬ìŠ¤íŠ¸/í¸ì§‘ í™”ë©´ ===== */

    function openMemoListScreen(bookIndex) {
      const books = loadBooks();
      const book = books[bookIndex];
      if (!book) return;

      memoBookIndex = bookIndex;

      const memos = ensureBookMemos(book);
      book.memo = memos.join("\n\n");
      books[bookIndex] = book;
      saveBooks(books);

      memoBookInfo.textContent = `${book.title}${book.author ? " Â· " + book.author : ""}`;
      renderMemoListFull(memos);

      memoEditScreen.classList.remove("active");
      memoScreen.classList.add("active");
      document.body.classList.add("modal-open");
    }

    function renderMemoListFull(memos) {
      memoListContainer.innerHTML = "";
      memoDragSourceIndex = null;
      memoDragJustHappened = false;

      if (!memos || memos.length === 0) {
        memoEmptyText.style.display = "block";
        return;
      }
      memoEmptyText.style.display = "none";

      memos.forEach((text, idx) => {
        const card = document.createElement("div");
        card.className = "memo-card-full";
        card.dataset.index = String(idx);

        const p = document.createElement("p");
        p.textContent = text || "";
        card.appendChild(p);

        // í´ë¦­ â†’ í¸ì§‘ (ë“œë˜ê·¸ ì§í›„ì—ëŠ” í´ë¦­ ë¬´ì‹œ)
        card.addEventListener("click", () => {
          if (memoDragJustHappened) {
            memoDragJustHappened = false;
            return;
          }
          openMemoEditScreen(idx);
        });

        // ë“œë˜ê·¸ ì‹œì‘
        card.addEventListener("pointerdown", () => {
          memoDragSourceIndex = idx;
          memoDragJustHappened = false;
          document.querySelectorAll(".memo-card-full").forEach(c => c.classList.remove("drag-source"));
          card.classList.add("drag-source");
        });

        memoListContainer.appendChild(card);
      });
    }

    // ë“œë˜ê·¸ ì¢…ë£Œ(ì†ì„ ë—ì„ ë•Œ) â€“ ì¹´ë“œ ìœ„ì¹˜ ë³€ê²½
    memoListContainer.addEventListener("pointerup", (e) => {
      if (memoDragSourceIndex == null || memoBookIndex == null) return;

      const targetCard = e.target.closest(".memo-card-full");
      const sourceIndex = memoDragSourceIndex;
      memoDragSourceIndex = null;
      document.querySelectorAll(".memo-card-full").forEach(c => c.classList.remove("drag-source"));

      if (!targetCard) return;

      const targetIndex = Number(targetCard.dataset.index);
      if (!Number.isInteger(targetIndex) || targetIndex === sourceIndex) return;

      const books = loadBooks();
      const book = books[memoBookIndex];
      if (!book) return;
      const memos = ensureBookMemos(book);

      if (sourceIndex < 0 || sourceIndex >= memos.length ||
          targetIndex < 0 || targetIndex >= memos.length) return;

      const [moved] = memos.splice(sourceIndex, 1);
      memos.splice(targetIndex, 0, moved);

      book.memos = memos;
      book.memo = memos.join("\n\n");
      books[memoBookIndex] = book;
      saveBooks(books);

      memoDragJustHappened = true;
      renderMemoListFull(memos);
      showToast("ë©”ëª¨ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
    });

    function closeAllMemoScreens() {
      memoScreen.classList.remove("active");
      memoEditScreen.classList.remove("active");
      document.body.classList.remove("modal-open");
      memoBookIndex = null;
      memoCardIndex = null;
      memoEditText.value = "";
      memoDragSourceIndex = null;
      memoDragJustHappened = false;
    }

    memoCloseBtn.addEventListener("click", closeAllMemoScreens);
    memoNewBtn.addEventListener("click", () => openMemoEditScreen(null));

    function openMemoEditScreen(index) {
      if (memoBookIndex == null) return;
      const books = loadBooks();
      const book = books[memoBookIndex];
      if (!book) return;

      const memos = ensureBookMemos(book);

      memoCardIndex = index;
      memoEditBookInfo.textContent = memoBookInfo.textContent;

      if (index == null) {
        memoEditText.value = "";
        memoEditDeleteBtn.style.display = "none";
      } else {
        memoEditText.value = memos[index] || "";
        memoEditDeleteBtn.style.display = "inline-block";
      }

      memoScreen.classList.remove("active");
      memoEditScreen.classList.add("active");
      document.body.classList.add("modal-open");
      memoEditText.focus();
    }

    memoEditBackBtn.addEventListener("click", () => {
      if (memoBookIndex == null) {
        closeAllMemoScreens();
        return;
      }
      const books = loadBooks();
      const book = books[memoBookIndex];
      if (!book) {
        closeAllMemoScreens();
        return;
      }
      const memos = ensureBookMemos(book);
      renderMemoListFull(memos);
      memoEditScreen.classList.remove("active");
      memoScreen.classList.add("active");
    });

    memoEditDeleteBtn.addEventListener("click", () => {
      if (memoBookIndex == null || memoCardIndex == null) return;
      if (!confirm("ì´ ë©”ëª¨ë¥¼ ì‚­ì œí• ê¹Œìš”?")) return;

      const books = loadBooks();
      const book = books[memoBookIndex];
      if (!book) return;
      const memos = ensureBookMemos(book);

      memos.splice(memoCardIndex, 1);
      book.memos = memos;
      book.memo = memos.join("\n\n");
      books[memoBookIndex] = book;
      saveBooks(books);

      showToast("ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      memoCardIndex = null;
      memoEditText.value = "";

      renderMemoListFull(memos);
      memoEditScreen.classList.remove("active");
      memoScreen.classList.add("active");
      renderList();
    });

    memoEditSaveBtn.addEventListener("click", () => {
      if (memoBookIndex == null) return;
      const text = memoEditText.value.trim();

      const books = loadBooks();
      const book = books[memoBookIndex];
      if (!book) return;
      const memos = ensureBookMemos(book);

      if (!text) {
        if (memoCardIndex != null) {
          memos.splice(memoCardIndex, 1);
          memoCardIndex = null;
        } else {
          showToast("ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");
          memoEditText.focus();
          return;
        }
      } else if (memoCardIndex == null) {
        memos.push(text);
        memoCardIndex = memos.length - 1;
      } else {
        memos[memoCardIndex] = text;
      }

      book.memos = memos;
      book.memo = memos.join("\n\n");
      books[memoBookIndex] = book;
      saveBooks(books);

      showToast("ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
      renderMemoListFull(memos);
      memoEditScreen.classList.remove("active");
      memoScreen.classList.add("active");
      renderList();
    });

    /* ===== ìˆ˜ì • ëª¨ë“œ / ì‚­ì œ ===== */

    function startEdit(index) {
      const books = loadBooks();
      const book = books[index];
      if (!book) return;

      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
      document.querySelector('.tab-btn[data-tab="input-section"]').classList.add("active");
      document.getElementById("input-section").classList.add("active");

      titleInput.value = book.title || "";
      authorInput.value = book.author || "";
      genreInput.value = book.genre || "";
      startInput.value = book.startDate || "";
      finishInput.value = book.finishDate || "";
      formatSelect.value = book.format || "";

      const memos = ensureBookMemos(book);
      memoInput.value = (memos && memos.length) ? memos.join("\n\n") : (book.memo || "");

      editIndexInput.value = String(index);
      submitBtn.textContent = "ìˆ˜ì • ì €ì¥";
      resetBtn.style.display = "inline-block";
      deleteBtn.style.display = "inline-block";
      titleInput.focus();
    }

    function deleteBook(index) {
      const books = loadBooks();
      books.splice(index, 1);
      saveBooks(books);
      clearForm();
      renderList();
      showToast("ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function formatToText(format) {
      switch (format) {
        case "ebook": return "eë¶";
        case "paper": return "ì¢…ì´ì±…";
        case "audio": return "ì˜¤ë””ì˜¤ë¶";
        default: return "-";
      }
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    /* ===== í†µê³„ ===== */
    function renderStats() {
      const books = loadBooks();
      const finished = books.filter(b => b.finishDate);

      if (finished.length === 0) {
        overallStatsDiv.textContent = "ì™„ë… ë‚ ì§œê°€ ìˆëŠ” ì±…ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.";
      } else {
        const count = finished.length;
        const firstYear = finished
          .map(b => b.finishDate.slice(0, 4))
          .filter(y => /^\d{4}$/.test(y));
        let yearsSpan = "";
        if (firstYear.length) {
          const minY = Math.min(...firstYear.map(Number));
          const maxY = Math.max(...firstYear.map(Number));
          yearsSpan = (minY === maxY) ? `${minY}ë…„` : `${minY}~${maxY}ë…„`;
        }
        overallStatsDiv.textContent =
          `ì™„ë… ${count}ê¶Œ` + (yearsSpan ? ` (${yearsSpan} ê¸°ì¤€)` : "");
      }

      const yearStats = {};
      finished.forEach(b => {
        if (!b.finishDate) return;
        const year = b.finishDate.slice(0, 4);
        if (!/^\d{4}$/.test(year)) return;
        if (!yearStats[year]) yearStats[year] = { count: 0 };
        yearStats[year].count += 1;
      });

      yearTbody.innerHTML = "";
      const years = Object.keys(yearStats).sort((a, b) => b.localeCompare(a));
      if (years.length === 0) {
        yearTable.style.display = "none";
        yearEmpty.style.display = "block";
      } else {
        yearTable.style.display = "table";
        yearEmpty.style.display = "none";
        years.forEach(year => {
          const stat = yearStats[year];
          const tr = document.createElement("tr");
          const tdYear = document.createElement("td");
          tdYear.textContent = year + "ë…„";
          const tdCount = document.createElement("td");
          tdCount.className = "center";
          tdCount.textContent = stat.count + "ê¶Œ";
          tr.appendChild(tdYear);
          tr.appendChild(tdCount);
          yearTbody.appendChild(tr);
        });
      }

      const monthStats = {};
      finished.forEach(b => {
        if (!b.finishDate) return;
        const ym = b.finishDate.slice(0, 7);
        if (!/^\d{4}-\d{2}$/.test(ym)) return;
        if (!monthStats[ym]) monthStats[ym] = { count: 0 };
        monthStats[ym].count += 1;
      });

      monthTbody.innerHTML = "";
      const months = Object.keys(monthStats).sort((a, b) => b.localeCompare(a));
      if (months.length === 0) {
        monthTable.style.display = "none";
        monthEmpty.style.display = "block";
      } else {
        monthTable.style.display = "table";
        monthEmpty.style.display = "none";
        months.forEach(ym => {
          const stat = monthStats[ym];
          const tr = document.createElement("tr");
          const tdYm = document.createElement("td");
          tdYm.textContent = ym;
          const tdCount = document.createElement("td");
          tdCount.className = "center";
          tdCount.textContent = stat.count + "ê¶Œ";
          tr.appendChild(tdYm);
          tr.appendChild(tdCount);
          monthTbody.appendChild(tr);
        });
      }
    }

    // ì´ˆê¸° ë Œë”
    window.addEventListener("load", () => {
      renderList();
    });
  </script>
</body>
</html>
